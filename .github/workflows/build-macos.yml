name: Build macOS Application

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.0)'
        required: true
        default: '1.0.0'
      release_notes:
        description: 'å‘å¸ƒè¯´æ˜'
        required: false
        default: 'è‡ªåŠ¨æ„å»ºçš„ macOS åº”ç”¨ç¨‹åº'

jobs:
  build-macos:
    runs-on: macos-latest  # ä½¿ç”¨æœ€æ–°çš„ macOS ç³»ç»Ÿ
    
    steps:
    # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç  - ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬
    - name: Checkout code
      uses: actions/checkout@v4  # æ›´æ–°åˆ° v4
    
    # æ­¥éª¤2ï¼šè®¾ç½® Python ç¯å¢ƒ
    - name: Set up Python
      uses: actions/setup-python@v5  # æ›´æ–°åˆ° v5
      with:
        python-version: '3.11'  # ä½¿ç”¨ Python 3.11ï¼ˆæ›´ç¨³å®šï¼‰
        cache: 'pip'
    
    # æ­¥éª¤3ï¼šæ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
    - name: Show environment info
      run: |
        echo "Python version:"
        python --version
        echo "Pip version:"
        pip --version
        echo "System info:"
        sw_vers
        echo "Disk space:"
        df -h
        echo "Current directory:"
        pwd
        echo "Files in directory:"
        ls -la
    
    # æ­¥éª¤4ï¼šå®‰è£…ä¾èµ–
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # æ£€æŸ¥ requirements.txt æ˜¯å¦å­˜åœ¨
        if [ -f "requirements.txt" ]; then
          pip install -r requirements.txt
        else
          echo "requirements.txt ä¸å­˜åœ¨ï¼Œå®‰è£…é»˜è®¤ä¾èµ–"
          pip install pyinstaller==6.5.0
        fi
        # ç¡®ä¿ tkinter å¯ç”¨ï¼ˆmacOS é€šå¸¸è‡ªå¸¦ï¼‰
        python -c "import tkinter; print('âœ… tkinter version:', tkinter.TkVersion)"
    
    # æ­¥éª¤5ï¼šåˆ›å»ºåº”ç”¨ç¨‹åºå›¾æ ‡ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
    - name: Create application icon
      run: |
        echo "åˆ›å»ºåº”ç”¨ç¨‹åºå›¾æ ‡..."
        
        # åˆ›å»º icons ç›®å½•
        mkdir -p icons
        
        # å¦‚æœæ²¡æœ‰å›¾æ ‡æ–‡ä»¶ï¼Œä½¿ç”¨é»˜è®¤å›¾æ ‡
        if [ ! -f "icons/icon.png" ]; then
          echo "ä½¿ç”¨ç®€å•æ–‡æœ¬åˆ›å»ºå›¾æ ‡..."
          
          # åˆ›å»ºç®€å•çš„SVGå›¾æ ‡
          cat > icons/icon.svg << 'EOF'
<svg width="512" height="512" xmlns="http://www.w3.org/2000/svg">
  <rect width="512" height="512" fill="#3498db"/>
  <circle cx="256" cy="256" r="200" fill="#2980b9" stroke="white" stroke-width="10"/>
  <text x="256" y="256" font-family="Arial" font-size="100" fill="white" text-anchor="middle" dy=".3em">BMR</text>
</svg>
EOF
          
          # å®‰è£… imagemagick æ¥è½¬æ¢æ ¼å¼
          brew install imagemagick || true
          
          # è½¬æ¢ SVG ä¸º PNG
          if command -v convert &> /dev/null; then
            convert icons/icon.svg icons/icon.png
            echo "âœ… å›¾æ ‡åˆ›å»ºå®Œæˆ"
          else
            echo "âš ï¸  æ— æ³•åˆ›å»ºå›¾æ ‡ï¼Œå°†ä½¿ç”¨é»˜è®¤å›¾æ ‡"
          fi
        fi
        
        # è½¬æ¢ä¸º .icns æ ¼å¼
        if [ -f "icons/icon.png" ]; then
          echo "è½¬æ¢ä¸º .icns æ ¼å¼..."
          mkdir -p icons/icon.iconset
          
          # ç”Ÿæˆå„ç§å°ºå¯¸çš„å›¾æ ‡
          sizes=(16 32 128 256 512)
          for size in "${sizes[@]}"; do
            sips -z $size $size icons/icon.png --out "icons/icon.iconset/icon_${size}x${size}.png" 2>/dev/null || true
          done
          
          # è½¬æ¢ä¸º icns
          iconutil -c icns icons/icon.iconset -o icons/icon.icns 2>/dev/null || true
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf icons/icon.iconset icons/icon.svg 2>/dev/null || true
          
          if [ -f "icons/icon.icns" ]; then
            echo "âœ… å›¾æ ‡åˆ›å»ºæˆåŠŸ"
          else
            echo "âš ï¸  å›¾æ ‡åˆ›å»ºå¤±è´¥ï¼Œå°†ä½¿ç”¨é»˜è®¤å›¾æ ‡"
          fi
        fi
    
    # æ­¥éª¤6ï¼šä½¿ç”¨ PyInstaller æ„å»ºåº”ç”¨ç¨‹åº
    - name: Build with PyInstaller
      run: |
        echo "å¼€å§‹æ„å»ºåº”ç”¨ç¨‹åº..."
        echo "å½“å‰ç›®å½•: $(pwd)"
        echo "æºä»£ç æ–‡ä»¶:"
        find . -name "*.py" -type f
        
        # æ£€æŸ¥ä¸»ç¨‹åºæ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "src/bmr_mac_gui.py" ]; then
          echo "âŒ é”™è¯¯: src/bmr_mac_gui.py ä¸å­˜åœ¨"
          echo "åˆ›å»ºæµ‹è¯•æ–‡ä»¶..."
          mkdir -p src
          cat > src/bmr_mac_gui.py << 'EOF'
import tkinter as tk
from tkinter import ttk, messagebox

def calculate_bmr():
    messagebox.showinfo("BMR è®¡ç®—å™¨", "è¿™æ˜¯æµ‹è¯•ç‰ˆæœ¬\nGitHub Actions æ„å»ºæˆåŠŸï¼")

root = tk.Tk()
root.title("BMR è®¡ç®—å™¨æµ‹è¯•ç‰ˆ")
btn = ttk.Button(root, text="ç‚¹å‡»æµ‹è¯•", command=calculate_bmr)
btn.pack(pady=50)
root.geometry("300x200")
root.mainloop()
EOF
        fi
        
        # è®¾ç½®å›¾æ ‡é€‰é¡¹
        ICON_OPTION=""
        if [ -f "icons/icon.icns" ]; then
          ICON_OPTION="--icon=icons/icon.icns"
          echo "ä½¿ç”¨è‡ªå®šä¹‰å›¾æ ‡"
        else
          echo "ä½¿ç”¨é»˜è®¤å›¾æ ‡"
        fi
        
        # æ¸…ç†æ—§çš„æ„å»ºæ–‡ä»¶
        rm -rf build dist *.spec 2>/dev/null || true
        
        # æ„å»ºåº”ç”¨ç¨‹åº
        echo "è¿è¡Œ PyInstaller..."
        pyinstaller \
          --name "BMRè®¡ç®—å™¨" \
          --windowed \
          --noconsole \
          --clean \
          --noconfirm \
          $ICON_OPTION \
          src/bmr_mac_gui.py
        
        echo "PyInstaller æ„å»ºå®Œæˆ"
        
        # æ£€æŸ¥æ„å»ºç»“æœ
        if [ -d "dist/BMRè®¡ç®—å™¨.app" ]; then
          echo "âœ… åº”ç”¨ç¨‹åºæ„å»ºæˆåŠŸ"
          echo "åº”ç”¨ç¨‹åºå¤§å°:"
          du -sh "dist/BMRè®¡ç®—å™¨.app"
        else
          echo "âŒ åº”ç”¨ç¨‹åºæ„å»ºå¤±è´¥"
          echo "å½“å‰ç›®å½•å†…å®¹:"
          ls -la
          echo "dist ç›®å½•å†…å®¹:"
          ls -la dist/ 2>/dev/null || echo "dist ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
    
    # æ­¥éª¤7ï¼šæµ‹è¯•åº”ç”¨ç¨‹åº
    - name: Test application
      run: |
        echo "æµ‹è¯•åº”ç”¨ç¨‹åº..."
        
        if [ -d "dist/BMRè®¡ç®—å™¨.app" ]; then
          echo "âœ… åº”ç”¨ç¨‹åºå­˜åœ¨"
          
          if [ -f "dist/BMRè®¡ç®—å™¨.app/Contents/MacOS/BMRè®¡ç®—å™¨" ]; then
            echo "âœ… å¯æ‰§è¡Œæ–‡ä»¶å­˜åœ¨"
            echo "æ–‡ä»¶ä¿¡æ¯:"
            file "dist/BMRè®¡ç®—å™¨.app/Contents/MacOS/BMRè®¡ç®—å™¨"
            echo "æ–‡ä»¶æƒé™:"
            ls -la "dist/BMRè®¡ç®—å™¨.app/Contents/MacOS/BMRè®¡ç®—å™¨"
          else
            echo "âŒ å¯æ‰§è¡Œæ–‡ä»¶ä¸å­˜åœ¨"
            echo "åº”ç”¨å†…å®¹:"
            find "dist/BMRè®¡ç®—å™¨.app" -type f
          fi
        fi
    
    # æ­¥éª¤8ï¼šåˆ›å»º DMG å®‰è£…åŒ…ï¼ˆå¯é€‰ï¼‰
    - name: Create DMG package
      run: |
        echo "åˆ›å»º DMG å®‰è£…åŒ…..."
        
        # å®‰è£… create-dmg
        brew install create-dmg || {
          echo "âš ï¸  create-dmg å®‰è£…å¤±è´¥ï¼Œè·³è¿‡ DMG åˆ›å»º"
          exit 0
        }
        
        # åˆ›å»º DMG
        create-dmg \
          --volname "BMRè®¡ç®—å™¨" \
          --window-pos 200 120 \
          --window-size 600 400 \
          --icon-size 100 \
          --icon "BMRè®¡ç®—å™¨.app" 175 190 \
          --hide-extension "BMRè®¡ç®—å™¨.app" \
          --app-drop-link 425 190 \
          --no-internet-enable \
          "BMRè®¡ç®—å™¨.dmg" \
          "dist/" 2>/dev/null || {
            echo "âš ï¸  DMG åˆ›å»ºå¤±è´¥ï¼Œä½†åº”ç”¨ç¨‹åºå·²æ„å»ºå®Œæˆ"
          }
        
        if [ -f "BMRè®¡ç®—å™¨.dmg" ]; then
          echo "âœ… DMG åˆ›å»ºæˆåŠŸ"
          ls -lh "BMRè®¡ç®—å™¨.dmg"
        fi
    
    # æ­¥éª¤9ï¼šä¸Šä¼ æ„å»ºäº§ç‰© - ä½¿ç”¨ v4
    - name: Upload artifacts
      uses: actions/upload-artifact@v4  # é‡è¦ï¼šæ›´æ–°åˆ° v4
      with:
        name: BMR-Calculator-macOS
        path: |
          dist/BMRè®¡ç®—å™¨.app
          BMRè®¡ç®—å™¨.dmg
        retention-days: 7
    
    # æ­¥éª¤10ï¼šæ˜¾ç¤ºæ„å»ºæ‘˜è¦
    - name: Build summary
      run: |
        echo "========================================"
        echo "ğŸ‰ æ„å»ºå®Œæˆï¼"
        echo "========================================"
        echo ""
        echo "ğŸ“¦ ç”Ÿæˆçš„æ–‡ä»¶:"
        echo ""
        
        if [ -d "dist/BMRè®¡ç®—å™¨.app" ]; then
          APP_SIZE=$(du -sh "dist/BMRè®¡ç®—å™¨.app" | cut -f1)
          echo "âœ… åº”ç”¨ç¨‹åº: dist/BMRè®¡ç®—å™¨.app ($APP_SIZE)"
        fi
        
        if [ -f "BMRè®¡ç®—å™¨.dmg" ]; then
          DMG_SIZE=$(ls -lh "BMRè®¡ç®—å™¨.dmg" | awk '{print $5}')
          echo "âœ… å®‰è£…åŒ…: BMRè®¡ç®—å™¨.dmg ($DMG_SIZE)"
        fi
        
        echo ""
        echo "ğŸ“¥ ä¸‹è½½è¯´æ˜:"
        echo "1. åœ¨ GitHub Actions é¡µé¢æ‰¾åˆ°æ­¤å·¥ä½œæµ"
        echo "2. ç‚¹å‡» 'Summary'"
        echo "3. åœ¨ 'Artifacts' éƒ¨åˆ†ä¸‹è½½æ–‡ä»¶"
        echo ""
        echo "ğŸ–¥ï¸ ä½¿ç”¨æ–¹æ³•:"
        echo "1. å°† BMRè®¡ç®—å™¨.app æ‹–åˆ° Applications æ–‡ä»¶å¤¹"
        echo "2. åŒå‡»æ‰“å¼€"
        echo "3. å¦‚æœæç¤ºå®‰å…¨è­¦å‘Šï¼Œå‰å¾€:"
        echo "   ç³»ç»Ÿè®¾ç½® â†’ éšç§ä¸å®‰å…¨æ€§ â†’ ä»è¦æ‰“å¼€"