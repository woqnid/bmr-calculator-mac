name: Build macOS Application

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.0)'
        required: true
        default: '1.0.0'
      release_notes:
        description: 'å‘å¸ƒè¯´æ˜'
        required: false
        default: 'è‡ªåŠ¨æ„å»ºçš„ macOS åº”ç”¨ç¨‹åº'

jobs:
  build-macos:
    runs-on: macos-latest
    
    steps:
    # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç 
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    # æ­¥éª¤2ï¼šè®¾ç½® Python ç¯å¢ƒ
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
    
    # æ­¥éª¤3ï¼šæ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
    - name: Show environment info
      run: |
        echo "Python version:"
        python --version
        echo "Pip version:"
        pip --version
        echo "System info:"
        sw_vers
        echo "Disk space:"
        df -h
    
    # æ­¥éª¤4ï¼šå®‰è£…ä¾èµ–
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pillow  # å®‰è£… Pillow ç”¨äºåˆ›å»ºå›¾æ ‡
        # ç¡®ä¿ tkinter å¯ç”¨ï¼ˆmacOS é€šå¸¸è‡ªå¸¦ï¼‰
        python -c "import tkinter; print('tkinter version:', tkinter.TkVersion)"
    
    # æ­¥éª¤5ï¼šåˆ›å»ºåº”ç”¨ç¨‹åºå›¾æ ‡
    - name: Create application icon
      run: |
        echo "åˆ›å»ºåº”ç”¨ç¨‹åºå›¾æ ‡..."
        
        # åˆ›å»º icons ç›®å½•
        mkdir -p icons
        
        # å¦‚æœæ²¡æœ‰å›¾æ ‡æ–‡ä»¶ï¼Œåˆ›å»ºä¸€ä¸ªç®€å•çš„
        if [ ! -f "icons/icon.png" ]; then
          echo "åˆ›å»ºé»˜è®¤å›¾æ ‡..."
          # ä½¿ç”¨ Python åˆ›å»ºç®€å•å›¾æ ‡
          python3 << 'EOF'
from PIL import Image, ImageDraw, ImageFont
import os

# åˆ›å»º 512x512 çš„å›¾ç‰‡
img = Image.new('RGB', (512, 512), color=(52, 152, 219))
draw = ImageDraw.Draw(img)

# ç”»ä¸€ä¸ªåœ†å½¢
draw.ellipse([50, 50, 462, 462], fill=(41, 128, 185), outline=(255, 255, 255), width=10)

try:
    # å°è¯•æ·»åŠ æ–‡å­—
    font = ImageFont.truetype('/System/Library/Fonts/Helvetica.ttc', 120)
except:
    # å¦‚æœæ‰¾ä¸åˆ°å­—ä½“ï¼Œä½¿ç”¨é»˜è®¤å­—ä½“
    try:
        font = ImageFont.truetype('/Library/Fonts/Arial.ttf', 120)
    except:
        font = ImageFont.load_default()

# æ·»åŠ æ–‡å­—
text = "BMR"
# è®¡ç®—æ–‡å­—ä½ç½®
bbox = draw.textbbox((0, 0), text, font=font)
text_width = bbox[2] - bbox[0]
text_height = bbox[3] - bbox[1]
x = (512 - text_width) // 2
y = (512 - text_height) // 2

draw.text((x, y), text, font=font, fill=(255, 255, 255))

# ä¿å­˜
img.save('icons/icon.png')
print('âœ… å›¾æ ‡åˆ›å»ºå®Œæˆ')
EOF
        fi
        
        # è½¬æ¢ä¸º .icns æ ¼å¼ï¼ˆmacOS åº”ç”¨å›¾æ ‡ï¼‰
        if [ -f "icons/icon.png" ]; then
          echo "è½¬æ¢ä¸º .icns æ ¼å¼..."
          mkdir -p icons/icon.iconset
          
          # ç”Ÿæˆå„ç§å°ºå¯¸çš„å›¾æ ‡
          sizes=(16 32 128 256 512)
          for size in "${sizes[@]}"; do
            sips -z $size $size icons/icon.png --out "icons/icon.iconset/icon_${size}x${size}.png" 2>/dev/null || true
            retina=$((size * 2))
            sips -z $retina $retina icons/icon.png --out "icons/icon.iconset/icon_${size}x${size}@2x.png" 2>/dev/null || true
          done
          
          # è½¬æ¢ä¸º icns
          iconutil -c icns icons/icon.iconset -o icons/icon.icns 2>/dev/null || true
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf icons/icon.iconset 2>/dev/null || true
          
          if [ -f "icons/icon.icns" ]; then
            echo "âœ… å›¾æ ‡åˆ›å»ºæˆåŠŸ"
          else
            echo "âš ï¸  å›¾æ ‡åˆ›å»ºå¤±è´¥ï¼Œå°†ä½¿ç”¨é»˜è®¤å›¾æ ‡"
          fi
        fi
    
    # æ­¥éª¤6ï¼šä½¿ç”¨ PyInstaller æ„å»ºåº”ç”¨ç¨‹åº
    - name: Build with PyInstaller
      run: |
        echo "å¼€å§‹æ„å»ºåº”ç”¨ç¨‹åº..."
        
        # è®¾ç½®å›¾æ ‡é€‰é¡¹
        ICON_OPTION=""
        if [ -f "icons/icon.icns" ]; then
          ICON_OPTION="--icon=icons/icon.icns"
          echo "ä½¿ç”¨è‡ªå®šä¹‰å›¾æ ‡"
        fi
        
        # æ¸…ç†æ—§çš„æ„å»ºæ–‡ä»¶
        rm -rf build dist *.spec 2>/dev/null || true
        
        # æ„å»ºåº”ç”¨ç¨‹åº
        echo "è¿è¡Œ PyInstaller..."
        pyinstaller \
          --name "BMRè®¡ç®—å™¨" \
          --windowed \
          --noconsole \
          --clean \
          --noconfirm \
          $ICON_OPTION \
          src/bmr_mac_gui.py
        
        echo "âœ… PyInstaller æ„å»ºå®Œæˆ"
        
        # æ£€æŸ¥æ„å»ºç»“æœ
        if [ -d "dist/BMRè®¡ç®—å™¨.app" ]; then
          echo "åº”ç”¨ç¨‹åºç»“æ„:"
          find "dist/BMRè®¡ç®—å™¨.app" -type f | head -20
          
          # æ˜¾ç¤ºåº”ç”¨å¤§å°
          echo "åº”ç”¨ç¨‹åºå¤§å°:"
          du -sh "dist/BMRè®¡ç®—å™¨.app"
        else
          echo "âŒ åº”ç”¨ç¨‹åºæ„å»ºå¤±è´¥"
          exit 1
        fi
    
    # æ­¥éª¤7ï¼šæµ‹è¯•åº”ç”¨ç¨‹åº
    - name: Test application
      run: |
        echo "æµ‹è¯•åº”ç”¨ç¨‹åº..."
        
        if [ -d "dist/BMRè®¡ç®—å™¨.app" ]; then
          echo "âœ… åº”ç”¨ç¨‹åºå­˜åœ¨"
          
          if [ -f "dist/BMRè®¡ç®—å™¨.app/Contents/MacOS/BMRè®¡ç®—å™¨" ]; then
            echo "âœ… å¯æ‰§è¡Œæ–‡ä»¶å­˜åœ¨"
            ls -la "dist/BMRè®¡ç®—å™¨.app/Contents/MacOS/BMRè®¡ç®—å™¨"
            file "dist/BMRè®¡ç®—å™¨.app/Contents/MacOS/BMRè®¡ç®—å™¨"
          else
            echo "âŒ å¯æ‰§è¡Œæ–‡ä»¶ä¸å­˜åœ¨"
            find "dist/BMRè®¡ç®—å™¨.app" -type f
          fi
        fi
    
    # æ­¥éª¤8ï¼šåˆ›å»º DMG å®‰è£…åŒ…
    - name: Create DMG package
      run: |
        echo "åˆ›å»º DMG å®‰è£…åŒ…..."
        
        # æ£€æŸ¥ create-dmg
        if ! command -v create-dmg &> /dev/null; then
          echo "å®‰è£… create-dmg..."
          brew install create-dmg || {
            echo "âš ï¸  create-dmg å®‰è£…å¤±è´¥ï¼Œè·³è¿‡ DMG åˆ›å»º"
            exit 0
          }
        fi
        
        # åˆ›å»ºä¸´æ—¶ç›®å½•
        mkdir -p dmg_temp
        cp -R "dist/BMRè®¡ç®—å™¨.app" dmg_temp/
        
        # åˆ›å»º DMG
        create-dmg \
          --volname "BMRè®¡ç®—å™¨" \
          --window-pos 200 120 \
          --window-size 600 400 \
          --icon-size 100 \
          --icon "BMRè®¡ç®—å™¨.app" 175 190 \
          --hide-extension "BMRè®¡ç®—å™¨.app" \
          --app-drop-link 425 190 \
          --no-internet-enable \
          "BMRè®¡ç®—å™¨.dmg" \
          "dmg_temp/" 2>/dev/null || {
            echo "âš ï¸  DMG åˆ›å»ºå¤±è´¥ï¼Œä½†åº”ç”¨ç¨‹åºå·²æ„å»ºå®Œæˆ"
          }
        
        # æ¸…ç†
        rm -rf dmg_temp
        
        if [ -f "BMRè®¡ç®—å™¨.dmg" ]; then
          echo "âœ… DMG åˆ›å»ºæˆåŠŸ"
          ls -lh "BMRè®¡ç®—å™¨.dmg"
        fi
    
    # æ­¥éª¤9ï¼šä¸Šä¼ æ„å»ºäº§ç‰©
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: BMR-Calculator-macOS
        path: |
          dist/BMRè®¡ç®—å™¨.app
          BMRè®¡ç®—å™¨.dmg
        retention-days: 7
    
    # æ­¥éª¤10ï¼šæ˜¾ç¤ºæ„å»ºæ‘˜è¦
    - name: Build summary
      run: |
        echo "========================================"
        echo "ğŸ‰ æ„å»ºå®Œæˆï¼"
        echo "========================================"
        echo ""
        echo "ğŸ“¦ ç”Ÿæˆçš„æ–‡ä»¶:"
        echo ""
        
        if [ -d "dist/BMRè®¡ç®—å™¨.app" ]; then
          APP_SIZE=$(du -sh "dist/BMRè®¡ç®—å™¨.app" | cut -f1)
          echo "âœ… åº”ç”¨ç¨‹åº: dist/BMRè®¡ç®—å™¨.app ($APP_SIZE)"
        fi
        
        if [ -f "BMRè®¡ç®—å™¨.dmg" ]; then
          DMG_SIZE=$(ls -lh "BMRè®¡ç®—å™¨.dmg" | awk '{print $5}')
          echo "âœ… å®‰è£…åŒ…: BMRè®¡ç®—å™¨.dmg ($DMG_SIZE)"
        fi
        
        echo ""
        echo "ğŸ“¥ ä¸‹è½½:"
        echo "åœ¨å³ä¾§çš„ 'Artifacts' éƒ¨åˆ†ä¸‹è½½æ–‡ä»¶"